import React, {Fragment} from 'react';
import {
    COLORS,
    MSG_CTRL_OFF,
    MSG_TYPES_DATA_HELP,
    MSG_TYPES_FULLNAME, TARGET_PRESET
} from "../pacer/constants";
import "./ControlStepsEditor.css";
import {getAvailableMessageTypes} from "../pacer/model";
import {DataInputField} from "./DataInputField";
import {observer} from "mobx-react-lite";
import {CONTROLS_DATA} from "../pacer/sysex";
import {stores} from "../stores";

const LEDMidi = ({ current_value, onChange }) => {
    return (
        <select value={current_value} onChange={(event) => onChange(event.target.value)}>
            <option value="0">OFF</option>
            <option value="1">ON</option>
        </select>
    );
};

const LEDColor = ({ current_value, onChange }) => {
    return (
        <select value={current_value} onChange={(event) => onChange(event.target.value)}>
            {Object.keys(COLORS).map(colorIndex => <option key={colorIndex} value={colorIndex}>{COLORS[colorIndex]}</option>)}
        </select>
    );
};

const LEDNum = ({ current_value, onChange }) => {
    return (
        <select value={current_value} onChange={(event) => onChange(event.target.value)}>
            <option value="0">default</option>
            <option value="3">top</option>
            <option value="2">middle</option>
            <option value="1">bottom</option>
        </select>
    );
};

/*
const MidiNote = ({ note, onChange }) => {
    return (
        <select value={note} onChange={(event) => onChange(event.target.value)} className="notes">
            {
                Array.from(Array(127).keys()).map(
                    i => {
                        let n = Note.fromMidi(i, true);
                        return <option key={i} value={i}>{n} ({i})</option>
                    })
            }
        </select>
    );
};
*/

const Step = observer(({ presetIndex, controlId, stepIndex, config }) => {

    // console.log(presetIndex, controlId, stepIndex, typeof presetIndex, typeof controlId, typeof stepIndex, JSON.stringify(config));

    const updateData = (dataIndex, value) => {
        stores.state.updateControlStep(controlId, stepIndex, "data", dataIndex, value, presetIndex);
    }
    const updateChannel = (value) => {
        stores.state.updateControlStep(controlId, stepIndex, "channel", null, value, presetIndex);
    }
    const updateLED = (led, value) => {
        stores.state.updateControlStep(controlId, stepIndex, led, null, value, presetIndex);
    }

    let inactive = config.msg_type === MSG_CTRL_OFF;

    // console.log("config.msg_type", config.msg_type, inactive, getAvailableMessageTypes(controlId));

    if (inactive) {
        return (
            <Fragment>
                <div className="step-row-header">Step {stepIndex}:</div>
                <div>
                    <select value={config.msg_type} onChange={(event) => stores.state.updateControlStepMessageType(controlId, stepIndex, event.target.value, presetIndex)}>
                        {getAvailableMessageTypes(controlId).map(mtype => <option key={mtype} value={mtype}>{MSG_TYPES_FULLNAME[mtype]}</option>)}
                    </select>
                </div>
                <div>
                </div>
                <div>
                </div>
                <div>
                </div>
                <div>
                </div>
                <div>
                </div>
                <div>
                </div>
                <div>
                </div>
                <div>
                </div>
            </Fragment>
        );
    }

    if (!config.data) return null;

    let d0, d1, d2;
    d0 = <DataInputField msgType={config.msg_type} value={config.data[0]} dataIndex={0} onChange={updateData} />;
    d1 = <DataInputField msgType={config.msg_type} value={config.data[1]} dataIndex={1} onChange={updateData} />;
    d2 = <DataInputField msgType={config.msg_type} value={config.data[2]} dataIndex={2} onChange={updateData} />;

    // console.log("config.msg_type", config.msg_type, typeof config.msg_type);

    return (
        <Fragment>
            <div className="step-row-header">Step {stepIndex}:</div>
            <div>
                <select value={config.msg_type} onChange={(event) => stores.state.updateControlStepMessageType(controlId, stepIndex, event.target.value, presetIndex)}>
                    {getAvailableMessageTypes(controlId).map(mtype => <option key={mtype} value={mtype}>{MSG_TYPES_FULLNAME[mtype]}</option>)}
                </select>
            </div>
            <div>{d0}<div className="data-help">{MSG_TYPES_DATA_HELP[config.msg_type] ? MSG_TYPES_DATA_HELP[config.msg_type][0] : ''}</div></div>
            <div>{d1}<div className="data-help">{MSG_TYPES_DATA_HELP[config.msg_type] ? MSG_TYPES_DATA_HELP[config.msg_type][1] : ''}</div></div>
            <div>{d2}<div className="data-help">{MSG_TYPES_DATA_HELP[config.msg_type] ? MSG_TYPES_DATA_HELP[config.msg_type][2] : ''}</div></div>
            <div>
                <select value={config.channel} onChange={(event) => updateChannel(event.target.value)}>
                    {Array.from(Array(17).keys()).map(i => <option key={i} value={i}>{i === 0 ? 'global' : i}</option>)}
                </select>
            </div>
            <div>
                <LEDColor current_value={config.led_inactive_color} onChange={(value) => updateLED("led_inactive_color", value)} />
            </div>
            <div>
                <LEDColor current_value={config.led_active_color} onChange={(value) => updateLED("led_active_color", value)} />
            </div>
            <div>
                <LEDNum current_value={config.led_num} onChange={(value) => updateLED("led_num", value)} />
            </div>
            <div>
                <LEDMidi current_value={config.led_midi_ctrl} onChange={(value) => updateLED("led_midi_ctrl", value)} />
            </div>
        </Fragment>
    );
});

export const ControlStepsEditor = observer(({presetIndex, controlId}) => {

    // render() {

        const steps = stores.state.data[TARGET_PRESET][presetIndex][CONTROLS_DATA][controlId]["steps"];

        // console.log(JSON.stringify(steps), Object.keys(steps));

        //FIXME: do not display LED for EXP and FS

        return (
            <div className="steps">
                <div></div>
                <div className="step-col-header">Type</div>
                <div className="step-col-header">Data 1</div>
                <div className="step-col-header">Data 2</div>
                <div className="step-col-header">Data 3</div>
                <div className="step-col-header">MIDI Ch.</div>
                <div className="step-col-header">LED Off</div>
                <div className="step-col-header">LED On</div>
                <div className="step-col-header">LED Num</div>
                <div className="step-col-header">LED MIDI</div>
                {Object.keys(steps).map(stepIndex =>
                    <Step key={stepIndex} presetIndex={presetIndex} controlId={controlId} stepIndex={stepIndex} config={steps[stepIndex]} />
                )}
            </div>
        );
    // }
});

// export default inject('state')(observer(ControlStepsEditor));
